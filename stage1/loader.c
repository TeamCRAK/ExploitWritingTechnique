/* 
* loader.c
* 
* Coded by TeamCR@K
*
* http://teamcrak.tistory.com
*
* - Compile & Execute 
*  <+> Linux  : gcc -Wall -o loader loader.c -ldl && LD_LIBRARY_PATH=. ./loader
*  <+> Windows: cl loader.c /D"WIN32" && loader.exe
*/
#include <stdio.h>
#ifdef WIN32
#  include <windows.h>
#  define EXT	"dll"
# else
#  define EXT	"so"
#  include <unistd.h>
#  include <dlfcn.h>
#  define LoadLibrary(soname) dlopen(soname, RTLD_LAZY)
#  define GetProcAddress dlsym
#  define FreeLibrary dlclose
#endif

#define SONAME	"teamcrak." EXT
#define FUNCNAME "library_call"

int main(void)
{
	int ret;
	void *dl = NULL;
	int (*func)(void) = NULL;	

	if((dl = LoadLibrary(SONAME)) == NULL) {
		fprintf(stderr, 
			"[%s] Can not load library: %s\n", __FILE__, SONAME);
		goto failed;
	}
	fprintf(stdout, "[%s] Loaded a library successfully: %s\n", 
		__FILE__, SONAME);

	if((func = (int (*)(void))GetProcAddress(dl, FUNCNAME)) == NULL) {
		fprintf(stderr, 
			"[%s] Not found %s() function from the library.\n", 
			__FILE__, FUNCNAME);

		goto failed;
	}
	fprintf(stdout, 
		"[%s] Loaded %s() function from '%s'\n"
		"[%s] %s() address: %p\n" , 
		__FILE__, FUNCNAME, SONAME, __FILE__, FUNCNAME, func);

	fprintf(stdout, "[%s] - FUNCTION CALL START\n", __FILE__);
	ret = func();
	fprintf(stdout, "[%s] - FUNCTION CALL END\n", __FILE__);
	
	fprintf(stdout, "[%s] Return value: %d\n", __FILE__, ret);
failed:
	if(dl != NULL)
		FreeLibrary(dl);
	return 0;
}

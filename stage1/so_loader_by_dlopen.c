/* 
* so_loader_by_dlopen.c
* 
* Coded by TeamCR@K
*
* http://teamcrak.tistory.com
*
* - A example c code for dlopen()
*/
#include <stdio.h>
#include <unistd.h>
#include <dlfcn.h>

int main(int argc, char **argv)
{
	int ret;
	void *dl = NULL;
	// XXX: Function prototype of teamcrak() in a shared object  
	int (*func)(const char *msg) = NULL;	

	if(argc != 4) {
		fprintf(stdout, "Usage: %s <SO-PATH> <FUNCTION-NAME> <MESSAGE>\n", argv[0]);
		return 0;
	}
	// XXX: Load a library
	if((dl = dlopen(argv[1], RTLD_LAZY)) == NULL) {
		fprintf(stderr, 
			"[%s] Can not load library: %s\n", __FILE__, argv[1]);
		goto failed;
	}

	// XXX: Map the function by loaded library
	if((func = (int (*)(const char *))dlsym(dl, argv[2])) == NULL) {
		fprintf(stderr, 
			"[%s] No such %s() function from the library.\n", 
			__FILE__, argv[2]);
		goto failed;
	}
	// XXX: Function-call using function pointer
	ret = func(argv[3]);
	
failed:
	if(dl != NULL)
		dlclose(dl); // XXX: Resource free
	return 0;
}
